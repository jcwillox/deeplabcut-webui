# https://taskfile.dev

version: "3"

vars:
  CONDA_ENV: dlc-webui

tasks:
  ### BACKEND ###
  backend:
    desc: "Run the backend"
    ignore_error: true
    deps: [is-conda-env]
    cmds:
      - uvicorn backend.main:app --reload

  backend:format:
    desc: Format backend code
    ignore_error: true
    preconditions:
      - sh: command -v black
        msg: black does not appear to be installed, try running "pip install black"
    cmds:
      - black ./backend {{.args}}

  backend:format:check:
    desc: Check format of the backend code
    cmds:
      - task: backend:format
        vars:
          args: --check --diff --color

  ### FRONTEND ###
  frontend:
    desc: "Run the frontend"
    ignore_error: true
    dir: ./frontend
    cmds:
      - npm run dev -s -- --clearScreen false

  ### MISC ###
  fullstack:
    desc: "Run the frontend and backend concurrently"
    deps: [backend, frontend]

  setup-conda:
    desc: "Setup/update the conda environment"
    deps: [has-conda]
    vars:
      envs:
        sh: conda env list
    cmds:
      - |
        {{- if (contains .CONDA_ENV .envs) -}}
          conda env update -f ./backend/conda.yaml --prune
        {{- else -}}
          conda env create -f ./backend/conda.yaml
        {{- end -}}

  dlc-gui:
    desc: "Open DeepLabCut's builtin GUI"
    deps: [is-conda-env]
    cmds:
      - ipython -c "from deeplabcut import launch_dlc; launch_dlc()"
    ignore_error: true

  ### UTILITIES ###
  has-conda:
    preconditions:
      - sh: command -v conda
        msg: conda not installed

  is-conda-env:
    deps: [has-conda]
    preconditions:
      - sh: '[[ "$CONDA_DEFAULT_ENV" == "{{.CONDA_ENV}}" ]]'
        msg: no conda environment found, try running "conda activate {{.CONDA_ENV}}"
